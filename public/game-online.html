<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü•ä Boxing Online - Multiplayer</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial Black', sans-serif;
        }
        
        #gameContainer {
            text-align: center;
            position: relative;
        }
        
        canvas {
            border: 5px solid #ffd700;
            border-radius: 10px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.8);
            display: none;
        }
        
        /* LOBBY */
        .lobby {
            background: linear-gradient(135deg, #1a1a2e, #2d0a0a);
            padding: 50px;
            border-radius: 20px;
            border: 5px solid #ffd700;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.9);
        }
        
        .lobby h1 {
            font-size: 48px;
            color: #ffd700;
            margin-bottom: 10px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
        }
        
        .lobby .subtitle {
            color: #95a5a6;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        .lobby input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 3px solid #ffd700;
            border-radius: 10px;
            margin-bottom: 15px;
            background: rgba(255,255,255,0.95);
            font-weight: bold;
        }
        
        .lobby button {
            width: 100%;
            padding: 18px;
            font-size: 22px;
            background: linear-gradient(to right, #ffd700, #ffed4e);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 12px;
            transition: all 0.3s;
        }
        
        .lobby button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(255,215,0,0.6);
        }
        
        .lobby button.secondary {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
        }
        
        .lobby .status {
            color: #ffd700;
            font-size: 16px;
            margin-top: 15px;
            min-height: 50px;
            padding: 15px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            border: 2px solid rgba(255,215,0,0.3);
        }
        
        .lobby .waiting {
            color: #3498db;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .lobby .room-id {
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid #2ecc71;
        }
        
        .lobby .room-id .label {
            color: #95a5a6;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .lobby .room-id .code {
            color: #2ecc71;
            font-size: 72px;
            font-weight: bold;
            letter-spacing: 15px;
            text-shadow: 0 0 20px rgba(46,204,113,0.6);
        }
        
        /* HUD */
        .hud {
            display: none;
            justify-content: space-between;
            margin-bottom: 10px;
            gap: 15px;
        }
        
        .player-stats {
            background: rgba(0,0,0,0.85);
            padding: 15px;
            border-radius: 10px;
            flex: 1;
            border: 3px solid;
        }
        
        .player1-stats { border-color: #4a90e2; }
        .player2-stats { border-color: #e74c3c; }
        
        .player-name {
            font-size: 18px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .player1-stats .player-name { color: #4a90e2; }
        .player2-stats .player-name { color: #e74c3c; }
        
        .hp-bar {
            width: 100%;
            height: 25px;
            background: rgba(0,0,0,0.5);
            border-radius: 5px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .hp-fill {
            height: 100%;
            transition: width 0.3s;
            background: linear-gradient(to right, #2ecc71, #27ae60);
        }
        
        .hp-text {
            color: white;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .back-btn {
            padding: 12px 25px;
            background: rgba(231,76,60,0.9);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: #c0392b;
            transform: scale(1.05);
        }
        
        /* GAME OVER */
        .game-over {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            justify-content: center;
            align-items: center;
            z-index: 5000;
        }
        
        .game-over-content {
            text-align: center;
            background: linear-gradient(135deg, #1a1a2e, #2d0a0a);
            padding: 50px;
            border-radius: 20px;
            border: 5px solid #ffd700;
        }
        
        .game-over h2 {
            font-size: 64px;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 4px 4px 8px rgba(0,0,0,0.8);
        }
        
        .game-over .winner {
            font-size: 32px;
            color: white;
            margin-bottom: 30px;
        }
        
        .game-over button {
            padding: 20px 50px;
            font-size: 24px;
            background: linear-gradient(to right, #ffd700, #ffed4e);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            margin: 0 10px;
        }
        
        .game-over button:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- LOBBY -->
        <div class="lobby" id="lobby">
            <h1>ü•ä BOXING ONLINE ü•ä</h1>
            <p class="subtitle">Ch∆°i v·ªõi b·∫°n b√® tr√™n 2 m√°y kh√°c nhau!</p>
            
            <div id="menuScreen">
                <input type="text" id="playerName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." maxlength="15" value="Player">
                <button onclick="createRoom()">üéÆ T·∫†O PH√íNG</button>
                <button class="secondary" onclick="showJoinScreen()">üåê V√ÄO PH√íNG</button>
                <button class="secondary" onclick="location.href='index.html'">üè† MENU CH√çNH</button>
            </div>
            
            <div id="joinScreen" style="display:none;">
                <input type="number" id="joinRoomId" placeholder="Nh·∫≠p m√£ 3 s·ªë (VD: 123)" maxlength="3" min="100" max="999" pattern="[0-9]{3}">
                <button onclick="joinRoom()">‚úÖ THAM GIA</button>
                <button class="secondary" onclick="showMenuScreen()">‚¨ÖÔ∏è QUAY L·∫†I</button>
            </div>
            
            <div id="roomScreen" style="display:none;">
                <div class="room-id">
                    <div class="label">M√É PH√íNG (Chia s·∫ª cho b·∫°n b√®):</div>
                    <div class="code" id="roomCode"></div>
                </div>
                <button onclick="copyRoomId()">üìã SAO CH√âP M√É</button>
                <button class="secondary" onclick="leaveRoom()">‚ùå R·ªúI PH√íNG</button>
            </div>
            
            <div class="status" id="status"></div>
        </div>
        
        <!-- HUD -->
        <div class="hud">
            <div class="player-stats player1-stats">
                <div class="player-name" id="p1Name">PLAYER 1</div>
                <div class="hp-bar">
                    <div class="hp-fill" id="p1Hp" style="width: 100%;"></div>
                </div>
                <div class="hp-text" id="p1HpText">HP: 100/100</div>
            </div>
            
            <button class="back-btn" onclick="leaveGame()">‚¨ÖÔ∏è R·ªúI TR·∫¨N</button>
            
            <div class="player-stats player2-stats">
                <div class="player-name" id="p2Name">PLAYER 2</div>
                <div class="hp-bar">
                    <div class="hp-fill" id="p2Hp" style="width: 100%;"></div>
                </div>
                <div class="hp-text" id="p2HpText">HP: 100/100</div>
            </div>
        </div>
        
        <!-- CANVAS -->
        <canvas id="gameCanvas" width="900" height="500"></canvas>
        
        <!-- GAME OVER -->
        <div class="game-over" id="gameOver">
            <div class="game-over-content">
                <h2>üèÜ GAME OVER üèÜ</h2>
                <div class="winner" id="winnerText"></div>
                <button onclick="playAgain()">üîÑ CH∆†I L·∫†I</button>
                <button onclick="leaveGame()">üè† MENU</button>
            </div>
        </div>
    </div>
    
    <script>
        // CANVAS & CONTEXT
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // PEER CONNECTION
        let peer = null;
        let conn = null;
        let myPeerId = '';
        let isHost = false;
        let playerName = '';
        let opponentName = '';
        
        // GAME STATE
        let gameRunning = false;
        let players = {};
        let keys = {};
        let localPlayerKey = '';
        
        // FIGHTER CLASS
        class Fighter {
            constructor(x, y, color, controls) {
                this.x = x;
                this.y = y;
                this.width = 50;
                this.height = 80;
                this.color = color;
                this.velocityX = 0;
                this.velocityY = 0;
                this.hp = 100;
                this.maxHp = 100;
                this.isJumping = false;
                this.controls = controls;
                this.punchCooldown = 0;
                this.kickCooldown = 0;
                this.isPunching = false;
                this.isKicking = false;
                this.facing = color === '#4a90e2' ? 1 : -1;
            }
            
            update() {
                // Only local player controls
                if (this === players[localPlayerKey]) {
                    // Movement
                    if (keys[this.controls.left]) this.velocityX = -5;
                    else if (keys[this.controls.right]) this.velocityX = 5;
                    else this.velocityX = 0;
                    
                    // Jump
                    if (keys[this.controls.jump] && !this.isJumping) {
                        this.velocityY = -15;
                        this.isJumping = true;
                    }
                    
                    // Punch
                    if (keys[this.controls.punch] && this.punchCooldown === 0) {
                        this.punch();
                    }
                    
                    // Kick
                    if (keys[this.controls.kick] && this.kickCooldown === 0) {
                        this.kick();
                    }
                }
                
                // Physics
                this.velocityY += 0.8; // gravity
                this.x += this.velocityX;
                this.y += this.velocityY;
                
                // Ground collision
                if (this.y + this.height >= canvas.height - 100) {
                    this.y = canvas.height - 100 - this.height;
                    this.velocityY = 0;
                    this.isJumping = false;
                }
                
                // Wall collision
                if (this.x < 0) this.x = 0;
                if (this.x + this.width > canvas.width) this.x = canvas.width - this.width;
                
                // Update facing direction
                if (this.velocityX > 0) this.facing = 1;
                else if (this.velocityX < 0) this.facing = -1;
                
                // Cooldowns
                if (this.punchCooldown > 0) this.punchCooldown--;
                if (this.kickCooldown > 0) this.kickCooldown--;
                if (this.isPunching && this.punchCooldown === 0) this.isPunching = false;
                if (this.isKicking && this.kickCooldown === 0) this.isKicking = false;
            }
            
            punch() {
                this.isPunching = true;
                this.punchCooldown = 30;
                
                // Check hit on opponent
                const opponent = localPlayerKey === 'player1' ? players.player2 : players.player1;
                if (this.checkHit(opponent, 60)) {
                    opponent.hp -= 10;
                    sendGameState();
                }
            }
            
            kick() {
                this.isKicking = true;
                this.kickCooldown = 45;
                
                // Check hit on opponent
                const opponent = localPlayerKey === 'player1' ? players.player2 : players.player1;
                if (this.checkHit(opponent, 80)) {
                    opponent.hp -= 15;
                    sendGameState();
                }
            }
            
            checkHit(target, range) {
                if (!target) return false;
                
                const hitboxX = this.x + (this.facing === 1 ? this.width : -range);
                const hitboxY = this.y;
                
                return (
                    hitboxX < target.x + target.width &&
                    hitboxX + range > target.x &&
                    hitboxY < target.y + target.height &&
                    hitboxY + this.height > target.y
                );
            }
            
            draw() {
                ctx.save();
                
                // Body
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                // Head
                ctx.fillStyle = '#ffdbac';
                ctx.beginPath();
                ctx.arc(this.x + this.width/2, this.y - 15, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // Punch animation
                if (this.isPunching) {
                    ctx.fillStyle = '#ff6b6b';
                    const punchX = this.x + (this.facing === 1 ? this.width : -40);
                    ctx.fillRect(punchX, this.y + 20, 40, 15);
                }
                
                // Kick animation
                if (this.isKicking) {
                    ctx.fillStyle = '#ffd93d';
                    const kickX = this.x + (this.facing === 1 ? this.width : -60);
                    ctx.fillRect(kickX, this.y + 50, 60, 15);
                }
                
                ctx.restore();
            }
        }
        
        // LOBBY FUNCTIONS
        function showMenuScreen() {
            document.getElementById('menuScreen').style.display = 'block';
            document.getElementById('joinScreen').style.display = 'none';
            document.getElementById('roomScreen').style.display = 'none';
            setStatus('');
        }
        
        function showJoinScreen() {
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('joinScreen').style.display = 'block';
            document.getElementById('roomScreen').style.display = 'none';
            setStatus('');
        }
        
        function setStatus(msg, isWaiting = false) {
            const status = document.getElementById('status');
            status.textContent = msg;
            status.className = isWaiting ? 'status waiting' : 'status';
        }
        
        function createRoom() {
            playerName = document.getElementById('playerName').value.trim() || 'Player';
            
            if (!peer) {
                // Generate 3-digit room code
                const roomCode = Math.floor(100 + Math.random() * 900).toString();
                
                peer = new Peer(roomCode);
                
                peer.on('open', (id) => {
                    myPeerId = id;
                    isHost = true;
                    
                    document.getElementById('menuScreen').style.display = 'none';
                    document.getElementById('roomScreen').style.display = 'block';
                    document.getElementById('roomCode').textContent = id;
                    setStatus('‚è≥ ƒêang ch·ªù ƒë·ªëi th·ªß k·∫øt n·ªëi...', true);
                });
                
                peer.on('connection', (connection) => {
                    conn = connection;
                    setupConnection();
                });
                
                peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    setStatus('‚ùå L·ªói: ' + err.type);
                });
            }
        }
        
        function joinRoom() {
            playerName = document.getElementById('playerName').value.trim() || 'Player';
            const roomId = document.getElementById('joinRoomId').value.trim();
            
            if (!roomId) {
                setStatus('‚ö†Ô∏è Vui l√≤ng nh·∫≠p m√£ ph√≤ng!');
                return;
            }
            
            // Validate 3-digit code
            if (!/^\d{3}$/.test(roomId)) {
                setStatus('‚ö†Ô∏è M√£ ph√≤ng ph·∫£i l√† 3 ch·ªØ s·ªë (VD: 123)');
                return;
            }
            
            if (!peer) {
                peer = new Peer();
                
                peer.on('open', (id) => {
                    myPeerId = id;
                    isHost = false;
                    
                    setStatus('üîó ƒêang k·∫øt n·ªëi ƒë·∫øn ph√≤ng...', true);
                    conn = peer.connect(roomId);
                    setupConnection();
                });
                
                peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    setStatus('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi: ' + err.type);
                });
            }
        }
        
        function setupConnection() {
            conn.on('open', () => {
                setStatus('‚úÖ ƒê√£ k·∫øt n·ªëi! ƒêang kh·ªüi ƒë·ªông game...', true);
                
                // Send player name
                conn.send({
                    type: 'playerName',
                    name: playerName
                });
                
                // Start game after 2 seconds
                setTimeout(startGame, 2000);
            });
            
            conn.on('data', (data) => {
                handleData(data);
            });
            
            conn.on('close', () => {
                setStatus('‚ùå ƒê·ªëi th·ªß ƒë√£ ng·∫Øt k·∫øt n·ªëi!');
                endGame();
            });
            
            conn.on('error', (err) => {
                console.error('Connection error:', err);
                setStatus('‚ùå L·ªói k·∫øt n·ªëi!');
            });
        }
        
        function handleData(data) {
            if (data.type === 'playerName') {
                opponentName = data.name;
            } else if (data.type === 'gameState') {
                // Update opponent state
                const opponentKey = localPlayerKey === 'player1' ? 'player2' : 'player1';
                const opponent = players[opponentKey];
                if (opponent) {
                    opponent.x = data.x;
                    opponent.y = data.y;
                    opponent.velocityX = data.velocityX;
                    opponent.velocityY = data.velocityY;
                    opponent.hp = data.hp;
                    opponent.isPunching = data.isPunching;
                    opponent.isKicking = data.isKicking;
                    opponent.facing = data.facing;
                }
                updateStats();
            } else if (data.type === 'gameOver') {
                showGameOver(data.winner);
            }
        }
        
        function sendGameState() {
            if (!conn || !conn.open) return;
            
            const localPlayer = players[localPlayerKey];
            if (!localPlayer) return;
            
            conn.send({
                type: 'gameState',
                x: localPlayer.x,
                y: localPlayer.y,
                velocityX: localPlayer.velocityX,
                velocityY: localPlayer.velocityY,
                hp: localPlayer.hp,
                isPunching: localPlayer.isPunching,
                isKicking: localPlayer.isKicking,
                facing: localPlayer.facing
            });
            
            // Check game over
            const opponent = localPlayerKey === 'player1' ? players.player2 : players.player1;
            if (opponent && opponent.hp <= 0) {
                conn.send({
                    type: 'gameOver',
                    winner: playerName
                });
                showGameOver(playerName);
            }
        }
        
        function copyRoomId() {
            const roomCode = document.getElementById('roomCode').textContent;
            navigator.clipboard.writeText(roomCode).then(() => {
                setStatus('‚úÖ ƒê√£ sao ch√©p m√£ ph√≤ng!');
                setTimeout(() => setStatus('‚è≥ ƒêang ch·ªù ƒë·ªëi th·ªß k·∫øt n·ªëi...', true), 2000);
            });
        }
        
        function leaveRoom() {
            if (conn) conn.close();
            if (peer) peer.destroy();
            peer = null;
            conn = null;
            showMenuScreen();
        }
        
        // GAME FUNCTIONS
        function startGame() {
            // Hide lobby, show game
            document.getElementById('lobby').style.display = 'none';
            document.querySelector('.hud').style.display = 'flex';
            canvas.style.display = 'block';
            
            // Determine local player
            localPlayerKey = isHost ? 'player1' : 'player2';
            
            // Create players
            players.player1 = new Fighter(100, 200, '#4a90e2', {
                left: 'a',
                right: 'd',
                jump: 'w',
                punch: 'f',
                kick: 'g'
            });
            
            players.player2 = new Fighter(750, 200, '#e74c3c', {
                left: 'arrowleft',
                right: 'arrowright',
                jump: 'arrowup',
                punch: '/',
                kick: '.'
            });
            
            // Set names
            document.getElementById('p1Name').textContent = isHost ? playerName : opponentName;
            document.getElementById('p2Name').textContent = isHost ? opponentName : playerName;
            
            gameRunning = true;
            gameLoop();
        }
        
        function gameLoop() {
            if (!gameRunning) return;
            
            // Clear canvas
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw floor
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(0, canvas.height - 100, canvas.width, 100);
            
            // Update and draw players
            if (players.player1) {
                players.player1.update();
                players.player1.draw();
            }
            if (players.player2) {
                players.player2.update();
                players.player2.draw();
            }
            
            // Send state
            if (gameRunning) {
                sendGameState();
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        function updateStats() {
            ['player1', 'player2'].forEach((key, i) => {
                const player = players[key];
                if (!player) return;
                
                const prefix = i === 0 ? 'p1' : 'p2';
                const hpPercent = Math.max(0, (player.hp / player.maxHp) * 100);
                
                document.getElementById(`${prefix}Hp`).style.width = hpPercent + '%';
                document.getElementById(`${prefix}HpText`).textContent = 
                    `HP: ${Math.max(0, Math.floor(player.hp))}/${player.maxHp}`;
            });
        }
        
        function showGameOver(winner) {
            gameRunning = false;
            document.getElementById('gameOver').style.display = 'flex';
            document.getElementById('winnerText').textContent = `${winner} TH·∫ÆNG!`;
        }
        
        function playAgain() {
            document.getElementById('gameOver').style.display = 'none';
            
            // Reset players
            if (players.player1) {
                players.player1.hp = 100;
                players.player1.x = 100;
                players.player1.y = 200;
            }
            if (players.player2) {
                players.player2.hp = 100;
                players.player2.x = 750;
                players.player2.y = 200;
            }
            
            updateStats();
            gameRunning = true;
            gameLoop();
        }
        
        function leaveGame() {
            gameRunning = false;
            document.getElementById('gameOver').style.display = 'none';
            canvas.style.display = 'none';
            document.querySelector('.hud').style.display = 'none';
            
            if (conn) conn.close();
            if (peer) peer.destroy();
            peer = null;
            conn = null;
            players = {};
            
            document.getElementById('lobby').style.display = 'block';
            showMenuScreen();
        }
        
        function endGame() {
            gameRunning = false;
            leaveGame();
        }
        
        // INPUT
        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
        });
        
        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });
        
        // Initialize
        console.log('ü•ä Boxing Online Ready!');
        console.log('‚úÖ PeerJS loaded - P2P multiplayer enabled');
    </script>
</body>
</html>
